<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Data Display</title>
    <style>
        .container {
            display: flex;
            width: 100%;
        }
        .column {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box; 
        }
        .column-1 {
            width: 25%;
        }
        .column-2 {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: 50%;
            height: 100%;
            z-index: 1000; 
        }
        .column-3 {
            width: 25%;
            margin-left: auto;
        }
        .section {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: black;
            font-size: 1em;
            text-align: center;
        }
        .section input, .section button {
            margin: 5px;
            font-size: 1em;
        }
        .textbox, .input-box {
            margin: 10px;
            padding: 10px;
            width: 80%;
            text-align: center;
            font-size: 1em;
        }
        .live-value-textbox {
            margin: 10px;
            padding: 10px;
            width: 80%;
            text-align: center;
            font-size: 2.5em !important; /* Increase font size for Live Value */
            font-weight: 600;
        }
        .button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
        }
        .button.active {
            background-color: lightgray;
        }
        .divider {
            width: 80%;
            height: 1px;
            background-color: black;
            margin: 10px auto;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .input-group input[type="checkbox"] {
            margin-left: 10px;
        }
        .label-text {
            font-size: 1em;
            margin: 5px;
        }
        img {
            width: 100%;
            height: auto;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            width: 90%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div class="column column-1">
            <div class="section">
                <div class="label-text" id="title">Live Value</div>
                <input type="text" class="live-value-textbox" id="value" value="" readonly>
                <label class="label-text" for="source-voltage">Source Voltage</label>
                <input type="number" class="input-box" id="source-voltage" value="0">
                <button class="button" id="start-button">Start</button>
                <button class="button" id="stop-button">Stop</button>
            </div>
            <div class="divider"></div>
            <div class="section">
                <div class="input-group">
                    <label class="label-text">
                        Chip Name
                        <input type="text" class="input-box" id="chip-name" disabled>
                        <input type="checkbox" id="chip-name-toggle" onchange="toggleInput('chip-name')">
                    </label>
                    <label class="label-text">
                        Experiment Name
                        <input type="text" class="input-box" id="experiment-name" disabled>
                        <input type="checkbox" id="experiment-name-toggle" onchange="toggleInput('experiment-name')">
                    </label>
                    <label class="label-text">
                        Component Name
                        <input type="text" class="input-box" id="component-name" disabled>
                        <input type="checkbox" id="component-name-toggle" onchange="toggleInput('component-name')">
                    </label>
                    <label class="label-text">
                        Measurement Type
                        <input type="text" class="input-box" id="measurement-type" disabled>
                        <input type="checkbox" id="measurement-type-toggle" onchange="toggleInput('measurement-type')">
                    </label>
                    <label class="label-text">
                        Working Directory
                        <input type="text" class="input-box" id="working-directory" disabled>
                        <input type="checkbox" id="working-directory-toggle" onchange="toggleInput('working-directory')">
                    </label>
                </div>
                <div class="divider"></div>
                <div class="input-group">
                    <label class="label-text">
                        Lower Limit (Volts)
                        <input type="number" class="input-box" id="lower-limit">
                    </label>
                    <label class="label-text">
                        Upper Limit (Volts)
                        <input type="number" class="input-box" id="upper-limit">
                    </label>
                    <label class="label-text">
                        Steps
                        <input type="number" class="input-box" id="steps">
                    </label>
                    <button class="button" id="sweep-button">Sweep</button>
                </div>
            </div>
            <div class="divider"></div>
            <div class="section" id="plot-section">
                <!-- Plot will be displayed here -->
            </div>
        </div>
        <div class="column column-2">
            <div class="label-text" id="title" style="text-align: center;">Live Camera Feed</div>
            <!-- Fetch /video_feed -->
            <div class="section">
                <img id="liveCamera" src="/video_feed" alt="Live Camera Feed">
                <!-- Sliders to adjust the video brightness and exposure -->
                <div class="slider-container">
                    <label class="label-text" for="brightness-slider">Brightness</label>
                    <input type="range" id="brightness-slider" class="slider" min="0" max="200" value="100">
                    <label class="label-text" for="contrast-slider">Contrast</label>
                    <input type="range" id="contrast-slider" class="slider" min="0" max="200" value="100">
                </div>
            </div>
        </div>
        <div class="column column-3">
            <div class="input-group">
                <div class="section">
                    <div class="label-text" id="title" style="text-align: center;">Power Meter Output</div>
                    <input type="text" class="input-box" id="power-meter" value="" readonly>
                    <button class="button" id="pm-start-button">Start</button>
                    <button class="button" id="pm-stop-button">Stop</button>
                    <div class="divider"></div>
                    <button class="button" id="pm-start-record-button">Start Recording</button>
                    <button class="button" id="pm-stop-record-button">Stop Recording</button>
                    <div class="divider"></div>
                    <button class="button" id="pm-zero-button">Zero</button>
                    <div class="divider"></div>
                    <div class="label-text" id="title" style="text-align: center;">Current Wavelength</div>
                    <input type="text" class="input-box" id="pm-wavelength" value="" readonly>
                    <div class="label-text" id="title" style="text-align: center;">Set New Wavelength (nm)</div>
                    <input type="text" class="input-box" id="new-pm-wavelength" value="">
                    <button class="button" id="set-wavelength-button">Set</button>
                    <div class="divider"></div>
                </div>
            </div>
            <div class="section">
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let pmValues = []; // stores power meter output
        let record = false;

        function downloadCSV(data) {
            const csvContent = "data:text/csv;charset=utf-8," + data.map(e => e).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "power_meter_data.csv");
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link); 
        }

        document.getElementById('pm-start-button').addEventListener('click', function() {
            fetch('/start_pm', { method: 'POST' });
            this.classList.add('active');
            document.getElementById('pm-stop-button').classList.remove('active');
        });

        document.getElementById('pm-stop-button').addEventListener('click', function() {
            fetch('/stop_pm', { method: 'POST' });
            this.classList.add('active');
            document.getElementById('pm-start-button').classList.remove('active');
        });

        document.getElementById('pm-start-record-button').addEventListener('click', function() {
            record = true;
            this.classList.add('active');
            document.getElementById('pm-start-button').classList.remove('active');
            pmValues = ["pm_value"]; // clear array
        });

        document.getElementById('pm-stop-record-button').addEventListener('click', function() {
            if(record) {
                record = false;
                downloadCSV(pmValues);
                pmValues = ["pm_value"]; // clear array
            }
            this.classList.add('active');
            document.getElementById('pm-start-record-button').classList.remove('active');
        });

        document.getElementById('pm-zero-button').addEventListener('click', function() {
            fetch('/zero_pm', { method: 'POST' })
                .then(response => {
                    if (response.status === 204) {
                        console.log('Zero was successful');
                    } else {
                        console.error('Zero was not successful');
                    }
                });
        });

        document.getElementById('start-button').addEventListener('click', function() {
            const sourceVoltage = parseFloat(document.getElementById('source-voltage').value);
            fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_voltage: sourceVoltage
                })
            });
            this.classList.add('active');
            document.getElementById('stop-button').classList.remove('active');
        });

        document.getElementById('stop-button').addEventListener('click', function() {
            fetch('/stop', { method: 'POST' });
            this.classList.add('active');
            document.getElementById('start-button').classList.remove('active');
        });
        

        socket.on('update_pm_value', function(data) {
            const pmValue = document.getElementById('power-meter');
            pmValue.value = data.value;
            if (record) {
                pmValues.push(data.value); // add value to array
            }
        });

        socket.on('update_pm_wavelength', function(data) {
            const pmWavelength = document.getElementById('pm-wavelength');
            pmWavelength.value = data.value;
        });

        document.getElementById('set-wavelength-button').addEventListener('click', function() {
            const pmWavelength = parseFloat(document.getElementById('new-pm-wavelength').value);
            fetch('/set_wavelength', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    wavelength: pmWavelength
                })
            });
            document.getElementById('new-pm-wavelength').value = '';
        });

        socket.on('update_value', function(data) {
            const liveValue = document.getElementById('value');
            liveValue.value = data.value;
            const unit = liveValue.value.split(' ')[1];
            switch (unit) {
                case 'Y':
                    liveValue.style.color = '#440154FF';
                    break;
                case 'Z':
                    liveValue.style.color = '#481567FF';
                    break;
                case 'E':
                    liveValue.style.color = '#482677FF';
                    break;
                case 'P':
                    liveValue.style.color = '#453781FF';
                    break;
                case 'T':
                    liveValue.style.color = '#404788FF';
                    break;
                case 'G':
                    liveValue.style.color = '#39568CFF';
                    break;
                case 'M':
                    liveValue.style.color = '#33638DFF';
                    break;
                case 'k':
                    liveValue.style.color = '#2D708EFF';
                    break;
                case 'm':
                    liveValue.style.color = '#287D8EFF';
                    break;
                case 'µ':
                    liveValue.style.color = '#238A8DFF';
                    break;
                case 'n':
                    liveValue.style.color = '#1F968BFF';
                    break;
                case 'p':
                    liveValue.style.color = '#20A387FF';
                    break;
                case 'f':
                    liveValue.style.color = '#29AF7FFF';
                    break;
                case 'a':
                    liveValuet.style.color = '#3CBB75FF';
                    break;
                case 'z':
                    liveValue.style.color = '#55C667FF';
                    break;
                case 'y':
                    liveValue.style.color = '#73D055FF';
                    break;
                default:
                    liveValue.style.color = 'black';
                    break;
            }
        });

        function toggleInput(inputId) {
            const input = document.getElementById(inputId);
            input.disabled = !input.disabled;
        }

        document.getElementById('sweep-button').addEventListener('click', function() {
            // Automatically press the stop button if it is not already pressed
            const stopButton = document.getElementById('stop-button');
            if (!stopButton.classList.contains('active')) {
                stopButton.click();
            }

            const chipName = document.getElementById('chip-name').value;
            const experimentName = document.getElementById('experiment-name').value;
            const componentName = document.getElementById('component-name').value;
            const measurementType = document.getElementById('measurement-type').value;
            const workingDirectory = document.getElementById('working-directory').value;
            const lowerLimit = document.getElementById('lower-limit').value;
            const upperLimit = document.getElementById('upper-limit').value;
            const steps = document.getElementById('steps').value;

            // Clear existing plot
            document.getElementById('plot-section').innerHTML = '';

            fetch('/sweep', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chip_name: chipName,
                    experiment_name: experimentName,
                    component_name: componentName,
                    measurement_type: measurementType,
                    working_directory: workingDirectory,
                    lower_limit: lowerLimit,
                    upper_limit: upperLimit,
                    steps: steps
                })
            })
            .then(response => response.json())
            .then(data => {
                const img = document.createElement('img');
                img.src = data.plot_url;
                img.style.maxWidth = '100%';
                img.onload = function() {
                    document.getElementById('plot-section').innerHTML = '';
                    document.getElementById('plot-section').appendChild(img);
                };
            })
            .catch(error => console.error('Error:', error));
        });


        // Add event listeners for the sliders
        document.getElementById('brightness-slider').addEventListener('input', function() {
            const brightnessValue = this.value;
            applyFilters();
        });

        document.getElementById('contrast-slider').addEventListener('input', function() {
            const contrastValue = this.value;
            applyFilters();
        });

        function applyFilters() {
            const brightnessValue = document.getElementById('brightness-slider').value;
            const contrastValue = document.getElementById('contrast-slider').value;
            const liveCamera = document.getElementById('liveCamera');
            liveCamera.style.filter = `brightness(${brightnessValue}%) contrast(${contrastValue}%)`;
        }
    </script>
</body>
</html>
